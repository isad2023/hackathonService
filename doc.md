# Документация сервиса Hackathon

## Обзор

Сервис Hackathon предоставляет API для управления хакатонами, командами, хакерами и решениями победителей. Сервис разработан с использованием FastAPI и PostgreSQL.

## Архитектура проекта

Проект организован следующим образом:
- `presentations/` - роутеры FastAPI и схемы данных
- `services/` - бизнес-логика
- `repository/` - работа с базой данных
- `persistent/db/` - модели данных
- `utils/` - утилиты, включая JWT-аутентификацию
- `infrastructure/` - настройки подключения к PostgreSQL
- `data/` - скрипты и данные для инициализации

## API Endpoints

### Хакатоны (Hackathons)
- `GET /hackathon/` - получить список всех хакатонов
- `POST /hackathon/` - создать новый хакатон
- `GET /hackathon/{hackathon_id}` - получить хакатон по ID

### Хакеры (Hackers)
- `GET /hacker/` - получить список всех хакеров
- `POST /hacker/` - создать или обновить хакера
- `POST /hacker/update_roles` - обновить роли хакера
- `GET /hacker/{hacker_id}` - получить хакера по ID

### Команды (Teams)
- `GET /team/` - получить список всех команд
- `POST /team/` - создать новую команду
- `GET /team/hackathon/{hackathon_id}` - получить список команд по ID хакатона
- `POST /team/add_hacker` - добавить хакера в команду
- `GET /team/my-teams` - получить список команд текущего пользователя
- `GET /team/{team_id}` - получить команду по ID

### Решения победителей (Winner Solutions)
- `GET /winner-solution/` - получить список всех решений победителей
- `POST /winner-solution/` - создать новое решение победителя
- `GET /winner-solution/{solution_id}` - получить решение победителя по ID

### Роли (Roles)
- `GET /role/` - получить список всех ролей

## Аутентификация

Сервис использует JWT-токены для аутентификации. Все эндпоинты требуют передачи токена в заголовке `Authorization: Bearer <token>`.

## Внесенные изменения и улучшения

1. **Автоматическое создание хакера**
   - Добавлена функциональность автоматического создания профиля хакера при создании команды или добавлении хакера в команду, если хакер не существует
   - Это улучшает UX, позволяя пользователям создавать команды без предварительного создания профиля хакера

2. **Обновление хакерского роутера**
   - Добавлена поддержка роли при создании хакера (поле `role_ids` в `HackerCreatePostRequest`)
   - Реализована логика для обновления ролей хакера

3. **Исправления в репозитории команд**
   - Улучшена логика добавления хакеров в команду
   - Добавлена проверка на уже существующего хакера в команде
   - Исправлена логика загрузки отношений для предотвращения ошибок сессии
   - Изменена стратегия загрузки связанных объектов для решения проблемы с WinnerSolution

4. **Исправление проблемы с WinnerSolution**
   - Решена проблема с кешированием объектов WinnerSolution в сессии SQLAlchemy
   - Улучшено управление сессиями в репозитории команд для избежания конфликтов при загрузке связанных объектов
   - Добавлено корректное завершение сессий и обработка ошибок при добавлении хакера в команду
   - Внесены изменения в сервисный слой для улучшения транзакционной логики

## Обнаруженные проблемы

1. **Ограничения уникальности**
   - Таблица команд имеет ограничение уникальности по (owner_id, name), что не позволяет одному пользователю создать несколько команд с одинаковым названием
   - Это ограничение стоит пересмотреть, возможно, добавив hackathon_id в ограничение уникальности

## Рекомендации по дальнейшему улучшению

1. **Улучшение обработки ошибок**
   - Добавить более детальные сообщения об ошибках
   - Реализовать глобальный обработчик исключений для последовательной обработки ошибок

2. **Оптимизация запросов к базе данных**
   - Дальнейшая оптимизация стратегий загрузки (eager loading vs lazy loading) для связанных объектов
   - Использовать более точные селективные запросы для минимизации нагрузки на базу данных

3. **Валидация данных**
   - Добавить более строгую валидацию входных данных
   - Улучшить проверку ограничений на размер команды, уникальность и т.д.

4. **Логирование**
   - Улучшить логирование для более удобной отладки
   - Добавить структурированное логирование

5. **Тесты**
   - Разработать автоматические тесты для проверки функциональности и предотвращения регрессий
   - Добавить интеграционные тесты для проверки взаимодействия компонентов

## Модели данных

### Hackathon
- id (UUID)
- name (String)
- task_description (Text)
- start_of_registration (DateTime)
- end_of_registration (DateTime)
- start_of_hack (DateTime)
- end_of_hack (DateTime)
- amount_money (Float)
- type (String)
- url (String)

### Hacker
- id (UUID)
- user_id (UUID)
- name (String)
- teams (Relationship)
- roles (Relationship)

### Team
- id (UUID)
- owner_id (UUID)
- hackathon_id (UUID)
- name (String)
- max_size (Integer)
- hackers (Relationship)
- winner_solutions (Relationship)

### Role
- id (UUID)
- name (String)
- hackers (Relationship)

### WinnerSolution
- id (UUID)
- hackathon_id (UUID)
- team_id (UUID)
- win_money (Float)
- link_to_solution (String)
- link_to_presentation (String)
- can_share (Boolean) 